# makefile

## makefile概述

- makefile 是一种用于自动构建软件的工具，它根据源代码文件的依赖关系，自动编译和链接生成可执行文件。管理大型项目十分重要。
- makefile 文件包含了一系列的规则，每个规则定义了如何从源文件生成目标文件。规则通常包括目标文件、依赖文件和命令。

## makefile的基本语法

- 规则的基本结构如下：

  - ````ini
    <目标文件>: <依赖文件>
    <命令>
    ````

- 目标文件是要生成的文件（还可以是“伪目标”一个label），依赖文件是生成目标文件所需的文件，命令（任意shell命令）是用于生成目标文件的操作。

## ps：make是一个命令行工具，用于根据 makefile 文件中的规则自动构建软件，解释makefile中的指令

## 伪目标

- 伪目标是指在 makefile 中定义的一个标签，它不是实际的文件，只是用于组织和管理规则。伪目标通常用于定义一些全局操作，例如清理、安装等。

- 伪目标的名称可以是任意字符串，但是为了避免与实际文件冲突，通常使用 .PHONY 作为伪目标的名称。
- 伪目标的规则中，通常不包含依赖文件，只包含命令。
- 伪目标的规则可以在 makefile 中的任何位置定义，但是通常放在文件的开头或结尾。

  - ````ini
    .PHONY: clean // 目标1,声明clean是一个伪目标，因为和实际文件clean冲突，所以声明为伪目标

    clean: // 目标2，伪目标clean的规则，用于清理生成的目标文件
        rm -f *.o executable 

    all： // 目标3，伪目标all的规则，用于生成所有可执行文件
        gcc -o executable *.o
    ````

## makefile变量

- 定义变量是代替一个文本字符串：系列文件的名字、传递编译器的参数、需要运行的程序、需要查找源代码的目录、需要输出信息的目录

### 自定义变量

- x=a // 变量在声明时需赋值，无需在使用前声明
- $(x) 或 ${x} // 取值
- 若要用真实的$，需转义：$$
- @echo $(x) // 隐藏打印变量x的值
- 变量的赋值：
  - 赋值运算符：=（文本位置无关，自动推导）、:=（覆盖式赋值，覆盖前面已定义变量为最新值）、?=（如果变量未定义，才赋值）、+=（追加赋值，在变量原有值后面追加）
  - 递归赋值：x=$(y)，y=$(z)，则x=z
  - 条件赋值：x=a ifneq (a,b)
  - 追加赋值：x+=a

### 自动变量

- $* 目标文件的文件名（不包含扩展名）
- $+ 所有的依赖文件（空格分隔，以出现的先后为顺序，包含重复依赖）
- $< 第一个依赖文件名称
- $? 所有比目标文件更新的依赖文件（空格分隔）
- $@ 目标文件完整名称
- $^ 所有的依赖文件（空格分隔，以出现的先后为顺序，不包含重复依赖）

### 隐含变量

- shell命令相关
  - AR 库文件维护程序名称，默认值为 ar
  - AS 汇编程序名称，默认值为 as
  - CC  C 编译器名称，默认值为 cc
  - CPP C预编译器名称，默认值为 $(CC) -E
  - CXX C++ 编译器名称，默认值为 g++
  - RM 删除文件程序名称，默认值为 rm -f

- 选项相关
  - ARFLAGS 库文件维护程序的选项，默认值为空
  - ASFLAGS 汇编程序的选项，默认值为空
  - CFLAGS C 编译器的选项，默认值为空
  - LDFLAGS 链接器的选项，默认值为空
  - CPPFLAGS C预编译器的选项，默认值为空
  - CXXFLAGS C++ 编译器的选项，默认值为空

## makefile条件判断

- ifeq (a,b) // 如果a等于b，则执行后面的命令
- ifneq (a,b) // 如果a不等于b，则执行后面的命令
- ifdef a // 如果变量a已定义，则执行后面的命令
- ifndef a // 如果变量a未定义，则执行后面的命令

## makefile的函数

### makefile常用函数

- 基本语法：$(function arguments) // 或者 ${function arguments}
- 函数名：function
- 参数：arguments

- 常用函数：
  - $（wildcard PATTERN）
    - 功能：查找当前目录下所有符合PATTERN模式的文件
    - 参数：PATTERN 文件名模式
    - 返回值：所有符合模式的文件名（空格分隔）
  - $(patsubst PATTERN,REPLACEMENT,TEXT)
    - 功能：将TEXT中所有符合PATTERN模式的字符串替换为REPLACEMENT
    - 参数：PATTERN 文件名模式，REPLACEMENT 替换字符串，TEXT 原始字符串
    - 返回值：替换后的字符串

### makefile自定义函数

- $(call EXPRESSION,PARM1,PARM2...)
  - 功能：调用自定义函数EXPRESSION，参数为PARM1和PARM2
  - 参数：EXPRESSION 自定义函数名，PARM1,PARM2...函数参数
  - 返回值：函数返回值

  - ````bash
    // 定义一个自定义函数add，用于计算两个数的和
    define add
      $(eval result := $(shell echo $$(($1 + $2))))
      $(result)
    endef

    // 调用自定义函数add，计算3和5的和
    sum := $(call add,3,5)

    // 打印sum的值
    @echo $(sum)
    ````

## make的使用

- make后的参数：

  - ````ini
    -C dir读入指定目录下的makefile
    -f file读入当前目录下的file文件作为makefile
    -i 忽略makefile中的错误
    -n 只打印命令，不执行（查看）
    -s 不打印命令（静默模式）
    ````
